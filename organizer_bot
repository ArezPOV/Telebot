import requests
import re

import logging
import telebot
import pandas as pd
from telebot import types
from constants import TG_TOKEN

logger = telebot.logger
telebot.logger.setLevel(logging.DEBUG)


class User:
    def __init__(self, user_id, name, currency, balance):
        self.user_id = user_id
        self.name = name
        self.currency = currency
        self.balance = balance


def run_organizer_bot(token: str) -> None:
    """Run financial organizer bot that helps you to spend money wisely"""
    bot = telebot.TeleBot(token, parse_mode=None)
    user_dict = {}

    @bot.message_handler(commands=['start'])
    def welcome_screen(message):
        chat_id = message.chat.id
        user = User(user_id=message.from_user.id, name=message.from_user.first_name, currency=None, balance=None)
        user_dict[chat_id] = user

        welcome_sticker = open('images/leo.webp', 'rb')
        bot.send_sticker(message.chat.id, welcome_sticker)
        bot.send_message(message.chat.id, "Welcome, {0.first_name}!".format(message.from_user, bot.get_me()) +
                         "\nMy name is <b>{1.first_name}</b>.".format(message.from_user, bot.get_me()) +
                         "\nI'm here to help you spend money <b>wisely!</b>", parse_mode='html')
        bot.send_message(message.chat.id, "I'm a financial organizer. I can do a few things for now:")
        bot.send_message(message.chat.id, "1. Add and save your current financial data\n"
                                          "2. Gather information about your expenditures\n"
                                          "3. Analyze the collected data and provide information about " +
                         "significant expenses.\n"
                         "4. Offer advice on reducing expenses based on the gathered data.")
        bot.send_message(message.chat.id, "New user? Write <b>/registration</b> to start", parse_mode='html')

    @bot.message_handler(commands=['registration'])
    def add_currency(message):
        try:
            markup = types.ReplyKeyboardMarkup(one_time_keyboard=True, resize_keyboard=True)
            key_usd = types.KeyboardButton('USD ðŸ‡ºðŸ‡¸')
            key_eur = types.KeyboardButton('EUR ðŸ‡ªðŸ‡º')
            key_rub = types.KeyboardButton('RUB ðŸ‡·ðŸ‡º')
            markup.add(key_usd, key_eur, key_rub)
            msg = bot.send_message(message.from_user.id, 'Your currency?', reply_markup=markup)
            bot.register_next_step_handler(msg, process_currency)

        except Exception as e:
            bot.reply_to(message, 'Something is wrong, write /start to start over!')

    def process_currency(message):
        try:
            chat_id = message.chat.id
            user = user_dict[chat_id]
            user.currency = message.text
            msg = bot.send_message(chat_id, "Your balance? (Integer/float)")
            bot.register_next_step_handler(msg, base_balance)

        except Exception as e:
            bot.reply_to(message, 'Something is wrong, write /start to start over!')

    def base_balance(message):
        chat_id = message.chat.id
        user = user_dict[chat_id]

        if message.text.isdigit():
            user.balance = message.text

            success_sticker = open('images/success.webp', 'rb')
            bot.send_sticker(chat_id, success_sticker)

            markup = types.InlineKeyboardMarkup()
            balance_btn = types.InlineKeyboardButton(text='Balance', callback_data='/balance')
            add_btn = types.InlineKeyboardButton(text='Add Money', callback_data='/add')
            advice_btn = types.InlineKeyboardButton(text='Advice', callback_data='/advice')
            markup.row(balance_btn, add_btn)
            markup.row(advice_btn)

            bot.send_message(chat_id, "Thank you, now you can start to use me", reply_markup=markup)

            save_user_data_to_file(user)

    def save_user_data_to_file(user):
        user_data = pd.DataFrame({
                'ID': [user.user_id],
                'Name': [user.name],
                'Currency': [user.currency],
                'Balance': [user.balance]
            })

        with pd.ExcelWriter("users.xlsx",
                            mode="a",
                            engine="openpyxl",
                            if_sheet_exists="overlay",
                            ) as writer:
            user_data.to_excel(writer, sheet_name="Users", header=False, startrow=1)

    @bot.message_handler(content_types=['text'])
    def process_balance(message):
        users = pd.read_excel('users.xlsx', sheet_name='Users')
        temp = users['Balance'].iloc[0].round(2)
        balance = temp.astype(float)
        currency = users['Currency'].iloc[0]

        if message.text.isdigit():
            add_balance = message.text
            balance += add_balance

            with pd.ExcelWriter("users.xlsx",
                                mode="a",
                                engine="openpyxl",
                                if_sheet_exists="overlay",
                                ) as writer:
                users.to_excel(writer, sheet_name="Users", header=False, startrow=1)

        bot.send_message(message, f'New balance: {balance} {currency}')

    @bot.callback_query_handler(func=lambda callback: True)
    def callback_worker(call):
        users = pd.read_excel('users.xlsx', sheet_name='Users')
        balance = users['Balance'].iloc[0].round(2)
        currency = users['Currency'].iloc[0]

        if call.data == '/balance':
            bot.send_message(call.from_user.id, f'Your balance: {balance} {currency}')
            markup = types.InlineKeyboardMarkup()
            advice_btn = types.InlineKeyboardButton(text='Yes', callback_data='/advice')
            markup.add(advice_btn)
            bot.send_message(call.from_user.id, 'Do you want an advice how to get more money?', reply_markup=markup)

        if call.data == '/add':
            msg = bot.send_message(call.from_user.id, 'Write how much balance to add?')
            bot.register_next_step_handler(msg, process_balance)

    bot.enable_save_next_step_handlers(delay=2)
    bot.load_next_step_handlers()
    bot.infinity_polling()


if __name__ == '__main__':
    run_organizer_bot(TG_TOKEN)
